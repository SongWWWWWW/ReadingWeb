# 用户注册流程文档

## 一、注册流程概览

用户注册流程分为前端交互、后端处理和数据库存储三个部分，采用前后端分离架构。

```
用户填写表单 → 前端验证 → 发送请求 → 后端验证 → 密码加密 → 保存数据库 → 返回结果
```

## 二、用户操作流程

### 1. 访问注册页面

- **路径**: `/register`
- **页面**: `frontend/src/views/Register.vue`
- **功能**: 显示注册表单

### 2. 填写注册信息

用户需要填写以下信息：

| 字段 | 说明 | 必填 | 验证规则 |
|------|------|------|----------|
| 用户名 | 用于登录的唯一标识 | ✅ | 3-20个字符 |
| 昵称 | 显示名称 | ✅ | 不能为空 |
| 邮箱 | 电子邮箱地址 | ✅ | 有效的邮箱格式 |
| 密码 | 登录密码 | ✅ | 至少6位字符 |

### 3. 提交注册

- 点击"注册"按钮
- 前端进行表单验证
- 验证通过后发送注册请求
- 注册成功后跳转到登录页面

## 三、前端注册流程

### 1. 表单验证规则

**位置**: `frontend/src/views/Register.vue`

```javascript
const rules = {
  username: [
    { required: true, message: '请输入用户名', trigger: 'blur' },
    { min: 3, max: 20, message: '用户名长度为3-20个字符', trigger: 'blur' }
  ],
  nickname: [
    { required: true, message: '请输入昵称', trigger: 'blur' }
  ],
  email: [
    { required: true, message: '请输入邮箱', trigger: 'blur' },
    { type: 'email', message: '请输入正确的邮箱格式', trigger: 'blur' }
  ],
  password: [
    { required: true, message: '请输入密码', trigger: 'blur' },
    { min: 6, message: '密码长度不能少于6位', trigger: 'blur' }
  ]
}
```

### 2. 注册请求处理

**位置**: `frontend/src/stores/user.js`

```javascript
const register = async (registerData) => {
  await authApi.register(registerData)
}
```

**API调用**: `frontend/src/utils/api.js`

```javascript
export const authApi = {
  register: (data) => request.post('/auth/register', data)
}
```

### 3. 请求数据格式

```json
{
  "username": "testuser",
  "nickname": "测试用户",
  "email": "test@example.com",
  "password": "123456"
}
```

### 4. 成功处理

- 显示成功提示："注册成功，请登录"
- 自动跳转到登录页面：`/login`

### 5. 错误处理

- 捕获后端返回的错误信息
- 通过 `ElMessage` 显示错误提示
- 常见错误：
  - "用户名已存在"
  - "邮箱已被注册"
  - 网络错误提示

## 四、后端注册流程

### 1. 接口定义

**位置**: `src/main/java/com/readingweb/controller/AuthController.java`

```java
@PostMapping("/register")
public Result<UserVO> register(@RequestBody RegisterDTO registerDTO) {
    UserVO userVO = userService.register(registerDTO);
    return Result.success("注册成功", userVO);
}
```

**接口路径**: `POST /api/auth/register`

**请求头**: `Content-Type: application/json`

### 2. 业务逻辑处理

**位置**: `src/main/java/com/readingweb/service/impl/UserServiceImpl.java`

#### 步骤1: 验证用户名唯一性

```java
User existingUser = userMapper.selectOne(
    new LambdaQueryWrapper<User>()
        .eq(User::getUsername, registerDTO.getUsername())
);

if (existingUser != null) {
    throw new IllegalArgumentException("用户名已存在");
}
```

#### 步骤2: 验证邮箱唯一性

```java
if (registerDTO.getEmail() != null && !registerDTO.getEmail().isEmpty()) {
    User existingEmail = userMapper.selectOne(
        new LambdaQueryWrapper<User>()
            .eq(User::getEmail, registerDTO.getEmail())
    );
    
    if (existingEmail != null) {
        throw new IllegalArgumentException("邮箱已被注册");
    }
}
```

#### 步骤3: 创建用户对象

```java
User user = new User();
user.setUsername(registerDTO.getUsername());
user.setPassword(PasswordUtil.encode(registerDTO.getPassword())); // 密码加密
user.setEmail(registerDTO.getEmail());
user.setNickname(registerDTO.getNickname() != null ? 
    registerDTO.getNickname() : registerDTO.getUsername()); // 昵称默认为用户名
user.setStatus(1); // 默认启用
user.setCreateTime(LocalDateTime.now());
user.setUpdateTime(LocalDateTime.now());
```

#### 步骤4: 保存到数据库

```java
userMapper.insert(user);
```

#### 步骤5: 返回用户信息

```java
UserVO userVO = new UserVO();
BeanUtils.copyProperties(user, userVO);
return userVO;
```

### 3. 密码加密

**位置**: `src/main/java/com/readingweb/util/PasswordUtil.java`

- 使用 **BCrypt** 算法加密密码
- 密码以哈希形式存储，不可逆
- 每次加密结果不同，提高安全性

### 4. 数据验证

**DTO定义**: `src/main/java/com/readingweb/dto/RegisterDTO.java`

```java
@Data
public class RegisterDTO {
    private String username;  // 用户名
    private String password;  // 密码
    private String email;     // 邮箱
    private String nickname;  // 昵称
}
```

## 五、数据库操作

### 1. 数据表结构

**表名**: `user`

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 用户ID | 主键，自增 |
| username | VARCHAR(50) | 用户名 | 唯一，非空 |
| password | VARCHAR(255) | 密码（加密后） | 非空 |
| email | VARCHAR(100) | 邮箱 | 唯一 |
| nickname | VARCHAR(50) | 昵称 | 可为空 |
| avatar | VARCHAR(255) | 头像URL | 可为空 |
| status | TINYINT | 状态（0-禁用，1-启用） | 默认1 |
| create_time | DATETIME | 创建时间 | 自动设置 |
| update_time | DATETIME | 更新时间 | 自动更新 |

### 2. 插入数据示例

注册成功后，数据库中的记录示例：

```sql
INSERT INTO `user` (`username`, `password`, `email`, `nickname`, `status`, `create_time`, `update_time`)
VALUES ('testuser', '$2a$10$...', 'test@example.com', '测试用户', 1, NOW(), NOW());
```

## 六、响应格式

### 1. 成功响应

**HTTP状态码**: `200`

```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "id": 1,
    "username": "testuser",
    "email": "test@example.com",
    "nickname": "测试用户",
    "avatar": null,
    "status": 1,
    "createTime": "2024-01-01T10:00:00",
    "updateTime": "2024-01-01T10:00:00"
  }
}
```

### 2. 错误响应

**HTTP状态码**: `500`

```json
{
  "code": 500,
  "message": "用户名已存在",
  "data": null
}
```

## 七、测试示例

### 1. 使用 Postman 测试

**请求配置**:
- **方法**: POST
- **URL**: `http://localhost:8080/api/auth/register`
- **Headers**: 
  ```
  Content-Type: application/json
  ```
- **Body** (JSON):
  ```json
  {
    "username": "testuser",
    "nickname": "测试用户",
    "email": "test@example.com",
    "password": "123456"
  }
  ```

### 2. 使用 curl 测试

```bash
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "nickname": "测试用户",
    "email": "test@example.com",
    "password": "123456"
  }'
```

### 3. 使用前端页面测试

1. 启动前端项目：`npm run dev`
2. 访问：`http://localhost:3000/register`
3. 填写注册信息
4. 点击"注册"按钮
5. 观察结果

## 八、常见问题

### 问题1: 用户名已存在

**原因**: 数据库中已存在相同的用户名

**解决方案**:
- 更换用户名
- 检查数据库中的用户表

**SQL查询**:
```sql
SELECT * FROM user WHERE username = 'testuser';
```

### 问题2: 邮箱已被注册

**原因**: 数据库中已存在相同的邮箱

**解决方案**:
- 使用其他邮箱
- 或使用已注册的邮箱登录

**SQL查询**:
```sql
SELECT * FROM user WHERE email = 'test@example.com';
```

### 问题3: 密码验证失败

**原因**: 密码长度不足6位

**解决方案**:
- 确保密码至少6位字符
- 前端和后端都有验证

### 问题4: 邮箱格式错误

**原因**: 邮箱格式不符合规范

**解决方案**:
- 检查邮箱格式（如：user@example.com）
- 前端会自动验证邮箱格式

### 问题5: 数据库连接失败

**原因**: 数据库配置错误或数据库未启动

**解决方案**:
1. 检查 `application.yml` 中的数据库配置
2. 确认数据库服务已启动
3. 确认数据库 `reading_web` 已创建

## 九、安全考虑

### 1. 密码安全

- ✅ 使用 BCrypt 加密算法
- ✅ 密码不存储在明文
- ✅ 前端不显示密码明文
- ✅ 密码长度至少6位

### 2. 数据验证

- ✅ 前端表单验证
- ✅ 后端参数验证
- ✅ 数据库唯一性约束
- ✅ 防止SQL注入（使用MyBatis Plus）

### 3. 错误处理

- ✅ 不暴露敏感信息
- ✅ 统一错误响应格式
- ✅ 全局异常处理

## 十、注册后的操作

注册成功后，用户需要：

1. **登录系统**
   - 使用注册的用户名和密码登录
   - 登录成功后获得 JWT Token

2. **完善个人信息**
   - 上传头像
   - 修改昵称
   - 更新邮箱

3. **开始使用**
   - 作为读者：浏览书籍、阅读、收藏
   - 作为作者：创建书籍、发布章节

## 十一、流程图

```
┌─────────────┐
│  用户访问    │
│ 注册页面     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 填写注册信息 │
│ (前端验证)   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 发送注册请求 │
│ POST /auth/ │
│  register   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 后端验证     │
│ - 用户名唯一 │
│ - 邮箱唯一   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 密码加密     │
│ (BCrypt)    │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 保存到数据库 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 返回用户信息 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 跳转登录页面 │
└─────────────┘
```

## 十二、相关文件

### 前端文件
- `frontend/src/views/Register.vue` - 注册页面组件
- `frontend/src/stores/user.js` - 用户状态管理
- `frontend/src/utils/api.js` - API接口封装
- `frontend/src/utils/request.js` - HTTP请求封装

### 后端文件
- `src/main/java/com/readingweb/controller/AuthController.java` - 认证控制器
- `src/main/java/com/readingweb/service/UserService.java` - 用户服务接口
- `src/main/java/com/readingweb/service/impl/UserServiceImpl.java` - 用户服务实现
- `src/main/java/com/readingweb/dto/RegisterDTO.java` - 注册DTO
- `src/main/java/com/readingweb/util/PasswordUtil.java` - 密码工具类
- `src/main/java/com/readingweb/entity/User.java` - 用户实体类

## 十三、后续优化建议

1. **邮箱验证**
   - 发送验证邮件
   - 验证邮箱有效性

2. **手机号注册**
   - 支持手机号注册
   - 短信验证码

3. **密码强度**
   - 增加密码复杂度要求
   - 密码强度提示

4. **图形验证码**
   - 防止恶意注册
   - 增加安全性

5. **注册协议**
   - 用户协议确认
   - 隐私政策同意

